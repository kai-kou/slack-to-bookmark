# Slack API設定ガイド

このガイドではSlack-to-Bookmarkプロジェクトで必要なSlack APIの設定方法について詳しく説明します。セットアップの所要時間は約10〜15分です。

> **注意**: Slackの管理画面は定期的に更新されるため、実際の画面と若干異なる場合があります。

## 目次

1. [Slackアプリの作成](#slackアプリの作成)
2. [権限（スコープ）の設定](#権限スコープの設定)
3. [APIトークンの取得](#apiトークンの取得)
4. [環境変数の設定](#環境変数の設定)
5. [セキュリティのベストプラクティス](#セキュリティのベストプラクティス)
6. [トラブルシューティング](#トラブルシューティング)
7. [よくある質問](#よくある質問)

## 概要

このプロジェクトでは、SlackのチャンネルやDMをChromeブックマークとして利用できるようにするために、Slack APIを使用してワークスペース内の情報を取得します。このガイドでは、必要なAPI設定手順を詳しく説明します。

## Slackアプリの作成

Slack APIを利用するには、まずSlackアプリを作成する必要があります。以下の手順に従ってください。

### 手順

1. [Slack APIウェブサイト](https://api.slack.com/apps)にアクセスし、Slackアカウントでログインします。

2. 「Create New App」ボタンをクリックします。

3. 「From scratch」を選択します。

4. アプリ名（例: 「Slack Bookmarks」）を入力し、使用するワークスペースを選択して「Create App」をクリックします。

### 重要ポイント

- **アプリ名**: 後でSlackのチャンネルなどに表示される名前になるため、分かりやすい名前を選びましょう。
- **ワークスペース**: アプリをインストールするワークスペースを選択します。後で他のワークスペースにも展開できます。
- **管理権限**: ワークスペースの管理者権限がない場合、一部の権限が制限される可能性があります。

## 権限（スコープ）の設定

作成したアプリに必要な権限（スコープ）を追加します。これらの権限により、アプリはチャンネルやユーザー情報にアクセスできるようになります。

### 必要な権限一覧

このプロジェクトでは、以下の4つの権限が必要です：

| 権限名 | 説明 | 必要な理由 |
|--------|------|------------|
| `channels:read` | 公開チャンネル情報の読み取り | 公開チャンネルのリストとIDを取得するため |
| `groups:read` | プライベートチャンネル情報の読み取り | プライベートチャンネルのリストとIDを取得するため |
| `users:read` | ユーザー情報の読み取り | ユーザー名とIDを取得するため |
| `im:read` | ダイレクトメッセージの読み取り | DMの情報を取得するため |

### 設定手順

1. 左側のメニューから「OAuth & Permissions」を選択します。

2. 「Scopes」セクションまでスクロールします。

3. 「User Token Scopes」（ユーザートークンスコープ）セクションで「Add an OAuth Scope」ボタンをクリックし、上記の4つの権限を一つずつ追加します。

### 権限設定時の注意点

- **重要**: 「User Token Scopes」に権限を追加してください（「Bot Token Scopes」ではありません）
- 4つの権限すべてを追加しないと、一部の機能が動作しません
- 権限を追加した後は、アプリを再インストールして新しいトークンを取得する必要があります

## APIトークンの取得

アプリの権限設定後、APIトークンを取得します。このトークンがあれば、アプリケーションはSlack APIにアクセスできるようになります。

### トークン取得手順

1. 「OAuth & Permissions」ページの上部にある「Install to Workspace」ボタンをクリックします。

2. 確認画面で「許可する」をクリックします。

3. インストール後、「User OAuth Token」（`xoxp-`で始まるトークン）が表示されます。これがアプリケーションで使用するAPIトークンです。

4. このトークンをコピーし、安全な場所に保管します（次のステップで使用します）。

### ユーザートークンとボットトークンの違い

- **ユーザートークン (xoxp-)**: このプロジェクトには必ずユーザートークンが必要です。ユーザーの代わりに操作を行い、プライベートチャンネルやDMにもアクセスできます。
- **ボットトークン (xoxb-)**: 通常のボットアプリで使用されますが、このプロジェクトでは機能が制限されるため使用できません。

## 環境変数の設定

取得したAPIトークンをプロジェクトの環境変数として設定します。この手順により、アプリケーションがSlack APIにアクセスできるようになります。

### 環境設定ファイルの作成

1. プロジェクトディレクトリにある`.env.sample`ファイルをコピーして`.env`ファイルを作成します。

   ```bash
   # Windowsの場合
   copy .env.sample .env
   
   # MacまたはLinuxの場合
   cp .env.sample .env
   ```

2. `.env`ファイルをテキストエディタで開き、以下の情報を入力します：

   ```
   SLACK_TOKEN=xoxp-あなたのAPIトークン
   WORKSPACE_NAME=あなたのワークスペース名
   WORKSPACE_ID=あなたのワークスペースID
   ```
   
   例（実際の値に置き換えてください）：
   ```
   SLACK_TOKEN=xoxp-YOUR_SLACK_API_TOKEN_HERE
   WORKSPACE_NAME=mycompany
   WORKSPACE_ID=T00000000
   ```

### ワークスペース情報の確認方法

#### ワークスペース名
- Slackの URL `https://{ワークスペース名}.slack.com` の部分
- 例: `https://mycompany.slack.com/` の場合は `mycompany`

#### ワークスペースID
1. **Slack URLから:**
   - ブラウザでSlackにログインし、URLを確認します
   - `https://app.slack.com/client/T01234ABCD/` の `T01234ABCD` 部分がワークスペースIDです

2. **Slackアプリの管理画面から:**
   - Slackで左上のワークスペース名をクリック
   - 「設定と管理」→「ワークスペースの設定」を選択
   - 「詳細情報」セクションでワークスペースIDを確認

### 環境変数設定時の注意点

- `.env`ファイルは決してGitリポジトリにコミットしないでください（セキュリティリスク）
- トークンは必ず`xoxp-`で始まるユーザートークンを使用してください
- ワークスペースIDは通常「T」で始まる文字列です

## セキュリティのベストプラクティス

Slack APIトークンは機密情報であり、適切に管理する必要があります。以下のセキュリティプラクティスを守りましょう：

### APIトークンの保護

1. **トークンを公開しない**: 
   - APIトークンをソースコードに直接記述しない
   - トークンをGitリポジトリにコミットしない
   - トークンをチャットやメールで共有しない
   - スクリーンショットにトークンが映らないよう注意する

2. **.envファイルの保護**: 
   - `.env`ファイルは必ず`.gitignore`に含める
   - ローカル環境でのみアクセス可能に管理する
   - バックアップを作成する場合は暗号化する

### 権限とアクセス管理

3. **最小権限の原則**: 
   - アプリケーションに必要最小限の権限のみを付与する
   - 不要な権限は削除する

4. **トークンのローテーション**: 
   - セキュリティリスクを減らすため、定期的にトークンを再生成する
   - 特に人事異動や退職者があった場合は更新を検討する

5. **アクセス制限**: 
   - トークンやコードにアクセスできる人を制限する
   - 共有開発環境での`.env`ファイルの取り扱いに注意する

### セキュリティチェックリスト

- [ ] `.env`ファイルが`.gitignore`に含まれている
- [ ] APIトークンがソースコード内に直接記述されていない
- [ ] 必要最小限の権限のみが付与されている
- [ ] トークンへのアクセスが適切に制限されている
- [ ] トークンの定期的な更新計画がある

## トラブルシューティング

### よくあるエラーと解決策

#### 1. APIリクエストエラー: 「not_allowed_token_type」

- **エラーメッセージ例**:
  ```
  Error: not_allowed_token_type
  ```
  
- **原因**: ボットトークン(xoxb-)を使用している、またはトークンに必要な権限がない

- **解決策**: 
  1. ユーザートークン(xoxp-)を使用していることを確認
  2. OAuth & Permissionsページで「User Token Scopes」の下に必要な権限が追加されているか確認
  3. アプリを再インストールして新しいトークンを取得

#### 2. 「プライベートチャンネルが見つからない」または「グループが見つからない」エラー

- **エラーメッセージ例**:
  ```
  Error retrieving private channels: missing_scope
  ```

- **原因**: アプリがプライベートチャンネルにアクセスできない

- **解決策**:
  1. `groups:read` 権限が追加されているか確認
  2. プライベートチャンネルを開き、`/invite @アプリ名` コマンドを実行してアプリを招待する

#### 3. 「Token revoked」エラー

- **エラーメッセージ例**:
  ```
  Error: token_revoked
  ```

- **原因**: トークンが無効化されている

- **解決策**:
  1. [Slack APIウェブサイト](https://api.slack.com/apps)で新しいトークンを生成
  2. `.env`ファイルを更新

#### 4. 「Missing scope」エラー

- **エラーメッセージ例**:
  ```
  Error: missing_scope
  ```

- **原因**: 必要なスコープ（権限）が不足している

- **解決策**:
  1. [Slack APIウェブサイト](https://api.slack.com/apps)のOAuth & Permissionsページで必要な権限を追加
  2. アプリを再インストールして新しいトークンを取得
  
#### 5. 「Invalid workspace ID」エラー

- **エラーメッセージ例**:
  ```
  Invalid workspace ID. Please check your .env file.
  ```

- **原因**: `.env`ファイルのワークスペースIDが正しくない

- **解決策**:
  1. 正しいワークスペースIDを確認（通常「T」で始まる文字列）
  2. `.env`ファイルを更新

### エラー診断のヒント

1. **ログを確認**: エラーメッセージを注意深く読み、問題を特定する
2. **設定を確認**: `.env`ファイルの内容が正しく設定されているか再確認
3. **権限を確認**: OAuth & Permissionsページで必要な権限がすべて追加されているか確認
4. **トークンを再生成**: 問題が解決しない場合は、アプリを再インストールして新しいトークンを取得

## よくある質問

### Q: ユーザートークン(xoxp-)とボットトークン(xoxb-)の違いは？
**A:** ユーザートークンはユーザーの権限でAPIにアクセスでき、プライベートチャンネルやDMにもアクセスできます。ボットトークンはボットの権限でのみアクセスでき、アクセスできる情報が制限されます。このプロジェクトにはユーザートークンが必要です。

### Q: トークンの有効期限はありますか？
**A:** 基本的にトークンに有効期限はありませんが、ユーザーがアプリを削除したり、管理者がアプリの権限を変更したりすると無効になることがあります。

### Q: アプリの名前を変更できますか？
**A:** はい、Slack API管理画面の「Basic Information」から変更できます。ただし、既にインストールしたワークスペースでは再インストールが必要になる場合があります。

### Q: 複数のワークスペースで使用できますか？
**A:** はい、各ワークスペースごとに異なるトークンを取得し、切り替えて使用できます。別の`.env`ファイルを作成するか、既存の`.env`ファイルを編集して使用してください。

### Q: デフォルトブラウザがChromeでない場合はどうすればいいですか？
**A:** 生成されたブックマークは主にChrome用ですが、他のブラウザでも使用できます。各ブラウザには独自のブックマークインポート方法があります。
- Firefox: ブックマークマネージャー > インポートとバックアップ > HTMLからインポート
- Edge: ブックマークマネージャー > ... > HTMLファイルからインポート
- Safari: ファイル > インポート > ブックマークHTML

### Q: Slackアプリの更新やAPIの変更に対応するにはどうすればいいですか？
**A:** Slack APIが更新された場合は、以下の手順に従ってください：
1. リポジトリを最新バージョンに更新（`git pull`または新しいZIPをダウンロード）
2. 必要に応じて`pip install -r requirements.txt`を再実行
3. Slackアプリの権限を確認し、新しい権限が必要な場合はアプリを更新

### Q: エラーが解決しない場合はどうすればいいですか？
**A:** [Slack API公式ドキュメント](https://api.slack.com/docs)を参照するか、[Slackコミュニティ](https://community.slack.com/)で質問してください。また、GitHubのIssueを作成して助けを求めることもできます。

---

以上の手順に従ってSlack APIを設定することで、Slack-to-Bookmarkアプリケーションが正常に動作するようになります。問題や質問がある場合は、お気軽にIssueを作成してください。

## 更新履歴

- 2025/3/14: ドキュメントを更新し、よくある質問とトラブルシューティングのセクションを追加
- 2025/3/5: 初期バージョンのドキュメント作成

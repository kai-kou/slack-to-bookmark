# Slack APIの「invalid_auth」エラー解決ガイド

「invalid_auth」エラーはSlack API認証の失敗を意味します。この問題を解決するために必要な手順を詳しく説明します。

## エラーの原因

「invalid_auth」エラーが発生する主な原因:

1. **トークンが無効または期限切れ**: 使用しているトークンが無効化されているか期限切れ
2. **トークンの形式が不正**: トークンの形式が正しくない
3. **権限不足**: トークンに必要な権限がない
4. **アプリが削除または再インストール**: Slackアプリがワークスペースから削除された、または再インストールされてトークンが変更された

## 解決方法

### 1. 新しいSlackアプリとトークンを作成する

1. [Slack API管理画面](https://api.slack.com/apps)にアクセス
2. 「Create New App」をクリック
   - 「From scratch」を選択
   - アプリ名を入力（例: "Slack to Bookmark"）
   - 使用するワークスペースを選択
   - 「Create App」をクリック

3. OAuth & Permissionsの設定:
   - 左側のメニューから「OAuth & Permissions」を選択
   - 「Scopes」セクションまでスクロール
   - 「User Token Scopes」で以下の権限を追加:
     - `users:read` - ユーザー情報の取得に必要
     - `channels:read` - 公開チャンネル情報の取得に必要
     - `groups:read` - プライベートチャンネル情報の取得に必要

4. アプリをワークスペースにインストール:
   - 同じページの上部にある「Install to Workspace」ボタンをクリック
   - 表示される認証画面で「許可する」をクリック

5. ユーザートークンを取得:
   - インストール後、「OAuth & Permissions」ページに「User OAuth Token」が表示されます
   - このトークン（`xoxp-`で始まる）をコピー

### 2. トークンを.envファイルに設定する

1. `.env`ファイルを開く
2. `SLACK_TOKEN`の値を新しいトークンに更新:
```
SLACK_TOKEN=xoxp-新しく取得したトークン
```

3. ワークスペース情報を確認:
   - `WORKSPACE_NAME`がSlackワークスペースのURL名と一致することを確認
   - `WORKSPACE_ID`が正しいこと（通常は「T」で始まるID）を確認

### 3. 保存して再実行

1. `.env`ファイルを保存
2. 再度スクリプトを実行:
```
python slack_to_bookmark.py
```

## トラブルシューティング

### それでもエラーが発生する場合

1. **スコープの確認**:
   - [Slack API管理画面](https://api.slack.com/apps)でアプリを開く
   - 「OAuth & Permissions」で必要なスコープが全て含まれているか確認

2. **トークンの有効性をテスト**:
   - `test_slack_token.py`スクリプトを実行して詳細なエラーを確認

3. **APIリクエストのレート制限**:
   - 短時間に多数のリクエストを送信した場合、一時的にブロックされることがある
   - 数分待ってから再試行

4. **ワークスペース管理者へ確認**:
   - 組織のポリシーによってアプリのインストールやAPIの使用が制限されている可能性
   - ワークスペース管理者に相談

5. **プロキシや環境の確認**:
   - ネットワークの制限やプロキシの設定がAPIへのアクセスを妨げていないか確認

### 管理者の方へ

ワークスペース管理者であれば、次の設定を確認してください:

1. **アプリディレクトリの設定**:
   - ワークスペース管理画面でアプリのインストール権限が適切に設定されているか確認

2. **組織のセキュリティ設定**:
   - 組織全体のAPIアクセス制限やアプリインストール制限を一時的に緩和して試行

## 参考リンク

- [Slack API ドキュメント](https://api.slack.com/docs)
- [Slack アプリの作成ガイド](https://api.slack.com/start/building)
- [Slack OAuth トークンのタイプ](https://api.slack.com/authentication/token-types)
